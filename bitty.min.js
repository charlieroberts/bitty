window.bitty={config:{flashTime:250,flashColor:"black",flashBackground:"white",value:"// itty bitty ide"},events:{},init(config={}){let el=null;el=void 0===config.element?document.querySelector('div[contenteditable="true"]'):config.element,Object.assign(bitty.config,config);config=bitty.config.value.split("\n").map(l=>`<div>${l}</div>`).join("");el.innerHTML=bitty.process(config,!0),bitty.editor(el),el.focus()},rules:[],process(el,isString=!1){let s;if(isString)s=el,bitty.rules.forEach(rule=>{s=s.replace(rule[0],rule[1])}),s=s.split("\n").join("<br />");else for(var node of el.children)s=node.innerText,bitty.rules.forEach(rule=>{s=s.replace(rule[0],rule[1])}),node.innerHTML=s.split("\n").join("<br/>");return s},subscribe(key,fcn){var events=bitty.events;void 0===events[key]&&(events[key]=[]),events[key].push(fcn)},unsubscribe(key,fcn){var events=bitty.events;void 0!==events[key]&&(events=events[key]).splice(events.indexOf(fcn),1)},publish(key,data){var events=bitty.events;void 0!==events[key]&&events[key].forEach(v=>v(data))},runBlock(){var str;let parentEl=window.getSelection().anchorNode.parentElement,divs=[];for(;"div"!==parentEl.localName;)parentEl=parentEl.parentElement;let pbg=parentEl.style.background,pcolor=parentEl.style.color;for(;null!==parentEl.previousSibling&&"\n"!==parentEl.previousSibling.innerText&&"div"===parentEl.previousSibling.localName;)parentEl=parentEl.previousSibling;for(divs.push(parentEl);null!==parentEl.nextSibling&&"\n"!==parentEl.nextSibling.innerText&&"div"===parentEl.nextSibling.localName;)parentEl=parentEl.nextSibling,divs.push(parentEl);divs.forEach(d=>{d.style&&(d.style.background=bitty.config.flashBackground,d.style.color=bitty.config.flashColor)}),setTimeout(_=>{divs.forEach(d=>{d.style&&(d.style.background=pbg,d.style.color=pcolor)})},bitty.config.flashTime),str=divs.map(d=>d.innerText).join("\n"),bitty.publish("run",str)},runSelection(){var sel=window.getSelection();let str=sel.toString();if(""===str){let parentEl=sel.anchorNode.parentElement;for(;"div"!==parentEl.localName;)parentEl=parentEl.parentElement;str=parentEl.innerText;let prevBg=parentEl.style.background,prevColor=parentEl.style.color;parentEl.style.background=bitty.config.flashBackground,parentEl.style.color=bitty.config.flashColor,setTimeout(()=>{parentEl.style.background=prevBg,parentEl.style.color=prevColor},bitty.config.flashTime)}else{let sheet=document.styleSheets[0],idx=sheet.insertRule("::selection{ color:black !important; background:white !important}");setTimeout(()=>sheet.removeRule(idx),250)}bitty.publish("run",str)},editor(el,highlight=bitty.js,tab="  "){let caret=()=>{var range=window.getSelection().getRangeAt(0),prefix=range.cloneRange();return prefix.selectNodeContents(el),prefix.setEnd(range.endContainer,range.endOffset),prefix.toString().length},setCaret=(pos,parent=el)=>{for(var node of parent.childNodes)if(node.nodeType==Node.TEXT_NODE){var range,sel;if(node.length>=pos)return range=document.createRange(),sel=window.getSelection(),range.setStart(node,pos),range.collapse(!0),sel.removeAllRanges(),sel.addRange(range),-1;pos-=node.length}else if((pos=setCaret(pos,node))<0)return pos;return pos};el.addEventListener("keydown",e=>{var pos,range;9===e.keyCode&&(pos=caret()+tab.length,(range=window.getSelection().getRangeAt(0)).deleteContents(),range.insertNode(document.createTextNode(tab)),highlight(el),setCaret(pos),e.preventDefault())}),el.addEventListener("keyup",e=>{var pos;!e.ctrlKey&&48<=e.keyCode||32===e.keyCode?(pos=caret(),highlight(el),setCaret(pos)):13===e.keyCode&&(e.ctrlKey?bitty.runSelection():e.altKey&&bitty.runBlock())})}};