window.bitty={config:{flashTime:250,flashColor:"black",flashBackground:"white",value:"// itty bitty ide"},events:{},rules:{},init(e={}){let t=null;t=void 0===e.element?document.querySelector('div[contenteditable="true"]'):e.element,bitty.el=t,Object.assign(bitty.config,e),bitty.value=bitty.config.value,bitty.editor(t),bitty.publish("init",t),t.focus()},set value(e){let t=bitty.process(e,!0);t=t.split("\n").map(e=>" "===e||""===e?" ":e).map(e=>`<div>${e}</div>`).join(""),bitty.el.innerHTML=t},get value(){return bitty.el.innerText},focus(){bitty.el.focus()},process(e,t=!1){let n;var i=Object.keys(bitty.rules),l=bitty.rules;if(t){n=e;for(var o of i)n=n.replace(l[o],`<span class=bitty-${o}>$1</span>`)}else for(var r of e.children){n=r.innerText;for(var s of i)n=n.replace(l[s],`<span class=bitty-${s}>$1</span>`);r.innerHTML=n.split("\n").join("<br/>")}return n},subscribe(e,t){var n=bitty.events;void 0===n[e]&&(n[e]=[]),n[e].push(t)},unsubscribe(e,t){var n=bitty.events;void 0!==n[e]&&(n=n[e]).splice(n.indexOf(t),1)},publish(e,t){var n=bitty.events;void 0!==n[e]&&n[e].forEach(e=>e(t))},runBlock(){var e;let t=window.getSelection().anchorNode.parentElement,n=[];for(;"div"!==t.localName;)t=t.parentElement;let i=t.style.background,l=t.style.color;for(;null!==t.previousSibling&&"\n"!==t.previousSibling.innerText&&"div"===t.previousSibling.localName;)t=t.previousSibling;for(n.push(t);null!==t.nextSibling&&"\n"!==t.nextSibling.innerText&&"div"===t.nextSibling.localName;)t=t.nextSibling,n.push(t);n.forEach(e=>{e.style&&(e.style.background=bitty.config.flashBackground,e.style.color=bitty.config.flashColor)}),setTimeout(e=>{n.forEach(e=>{e.style&&(e.style.background=i,e.style.color=l)})},bitty.config.flashTime),e=n.map(e=>e.innerText).join("\n"),bitty.publish("run",e)},runSelection(){var i=window.getSelection();let l=i.toString();if(""===l){let e=i.anchorNode.parentElement;for(;"div"!==e.localName;)e=e.parentElement;l=e.innerText;let t=e.style.background,n=e.style.color;e.style.background=bitty.config.flashBackground,e.style.color=bitty.config.flashColor,setTimeout(()=>{e.style.background=t,e.style.color=n},bitty.config.flashTime)}else{let e=document.styleSheets[0],t=e.insertRule("::selection{ color:black !important; background:white !important}");setTimeout(()=>e.removeRule(t),250)}bitty.publish("run",l)},editor(o,n=bitty.process,i="  "){let l=()=>{var e=window.getSelection().getRangeAt(0),t=e.cloneRange();return t.selectNodeContents(o),t.setEnd(e.endContainer,e.endOffset),t.toString().length},r=(e,t=o)=>{for(var n of t.childNodes)if(n.nodeType==Node.TEXT_NODE){var i,l;if(n.length>=e)return i=document.createRange(),l=window.getSelection(),i.setStart(n,e),i.collapse(!0),l.removeAllRanges(),l.addRange(i),-1;e-=n.length}else if((e=r(e,n))<0)return e;return e};new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.length?bitty.publish("nodes added",e.addedNodes):bitty.publish("nodes removed",e.removedNodes)})}).observe(o,{childList:!0}),o.addEventListener("paste",function(e){1===(e.clipboardData||window.clipboardData).getData("text/plain").split("\n").length||!window.getSelection().rangeCount||""!==e.target.innerText&&"\n"!==e.target.innerText||e.target.remove()}),o.addEventListener("keydown",e=>{var t,n;9===e.keyCode?(t=l()+i.length,(n=window.getSelection().getRangeAt(0)).deleteContents(),n.insertNode(document.createTextNode(i)),r(t),e.preventDefault()):8===e.keyCode&&setTimeout(e=>{"<br>"===bitty.el.innerHTML&&(bitty.el.innerHTML="<div> </div>",r(0))},10),bitty.publish("keydown",e)}),o.addEventListener("keyup",e=>{if(!e.ctrlKey&&48<=e.keyCode||32===e.keyCode){var t=l();n(o),r(t)}else switch(e.keyCode){case 8:break;case 13:e.ctrlKey?bitty.runSelection():e.altKey&&bitty.runBlock()}bitty.publish("keyup",e)}),o.addEventListener("click",e=>bitty.publish("click",e))}};