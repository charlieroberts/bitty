let bitty=window.bitty={instances:[],config:{flashTime:250,flashColor:"black",flashBackground:"white",value:"// itty bitty ide"},events:{},rules:{},undoManager(i){var e={history:[],rules:{},undoIdx:0,save(e){this.undoIdx<this.history.length-1&&(this.history=this.history.slice(0,this.undoIdx+1),this.undoIdx++);var t=i.el.innerHTML;for(t===this.history[this.undoIdx]&&1!==e||(this.history.push(t),this.undoIdx=this.history.length-1);50<this.history.length;)this.history.shift()},undo(){var e;0<this.undoIdx&&(e=this.history[this.undoIdx-1],i.el.innerHTML=e,this.undoIdx--)},redo(){var e;this.history[this.undoIdx+1]&&(e=this.history[this.undoIdx+1],i.el.innerHTML=e,this.undoIdx++)}};return i.subscribe("keydown",e.save.bind(e)),i.subscribe("paste",e.save.bind(e)),e},create(e={}){let t=null;t=void 0===e.el?document.querySelector('[contenteditable="true"]'):e.el;var i=Object.create(bitty),e=(i.el=t,Object.defineProperty(i,"value",{set(e){e=this.process(e,!0),e=this.divide(e);this.el.innerHTML=e},get(){return this.el.innerText}}),Object.assign({},bitty.config,e)),n=e.value;return delete e.value,Object.assign(i,e,{events:{}}),void 0!==n&&(i.value=n),i.editor(i,t),i.publish("init",i),i.undoManager=bitty.undoManager(i),bitty.publish("new",i),t.focus(),bitty.instances.push(i),i},divide(e){return e.split("\n").map(e=>" "===e||""===e?" ":e).map(e=>`<div>${e}</div>`).join("")},focus(){this.el.focus()},process(e,t=!1){var i=this.el,n=Object.keys(this.rules),r=this.rules;if(t)for(var o of n)e=e.replace(r[o],`<span class=bitty-${o}>$1</span>`);else for(var s of i.children){e=s.innerText;for(var l of n)e=e.replace(r[l],`<span class=bitty-${l}>$1</span>`);s.innerHTML=e.split("\n").join("<br/>")}return e},subscribe(e,t){var i=this.events;void 0===i[e]&&(i[e]=[]),i[e].push(t)},unsubscribe(e,t){var i=this.events;void 0!==i[e]&&(i=i[e]).splice(i.indexOf(t),1)},publish(e,t){var i=this.events;void 0!==i[e]&&i[e].forEach(e=>e(t))},runBlock(){var e;let t=window.getSelection().anchorNode.parentElement,i=[];for(;"div"!==t.localName;)t=t.parentElement;let n=t.style.background,r=t.style.color;for(;null!==t.previousSibling&&"\n"!==t.previousSibling.innerText&&"div"===t.previousSibling.localName;)t=t.previousSibling;for(i.push(t);null!==t.nextSibling&&"\n"!==t.nextSibling.innerText&&"div"===t.nextSibling.localName;)t=t.nextSibling,i.push(t);i.forEach(e=>{e.style&&(e.style.background=bitty.config.flashBackground,e.style.color=bitty.config.flashColor)}),setTimeout(e=>{i.forEach(e=>{e.style&&(e.style.background=n,e.style.color=r)})},this.config.flashTime),e=i.map(e=>e.innerText).join("\n"),this.publish("run",e)},runSelection(){var n=window.getSelection();let r=n.toString();if(""===r){let e=n.anchorNode.parentElement;for(;"div"!==e.localName;)e=e.parentElement;r=e.innerText;let t=e.style.background,i=e.style.color;e.style.background=bitty.config.flashBackground,e.style.color=bitty.config.flashColor,setTimeout(()=>{e.style.background=t,e.style.color=i},this.config.flashTime)}else{let e=document.styleSheets[0],t=e.insertRule("::selection{ color:black !important; background:white !important}");setTimeout(()=>e.removeRule(t),250)}this.publish("run",r)},editor(e,o,n="  "){let s=e,l=()=>{var e=window.getSelection().getRangeAt(0),t=e.cloneRange();return t.selectNodeContents(o),t.setEnd(e.endContainer,e.endOffset),t.toString().length},a=(e,t=o)=>{for(var i of t.childNodes)if(i.nodeType==Node.TEXT_NODE){var n,r;if(i.length>=e)return n=document.createRange(),r=window.getSelection(),n.setStart(i,e),n.collapse(!0),r.removeAllRanges(),r.addRange(n),-1;e-=i.length}else if((e=a(e,i))<0)return e;return e};new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.length?s.publish("nodes added",e.addedNodes):s.publish("nodes removed",e.removedNodes)})}).observe(o,{childList:!0});o.addEventListener("paste",e=>{var t=(e.clipboardData||window.clipboardData).getData("text/plain");if(1!==t.split("\n").length&&window.getSelection().rangeCount){let n=l();var i=t.split("\n").length-1,t=(n+=t.length-i,""===e.target.innerText||" "===e.target.innerText||"\n"===e.target.innerText||"<br>"===e.target.innerText);e.target!==s.el&&t&&e.target.remove(),setTimeout(()=>{s.el.innerHTML=s.divide(s.value),s.process(),setTimeout(()=>{for(var e of Array.from(s.el.childNodes))if(3!==e.nodeType){var t=e.querySelectorAll("div");if(1<t.length)for(var i of t)s.el.insertBefore(i,e)}a(n)},0)},0),s.publish("paste",e)}}),o.addEventListener("keydown",e=>{var t,i;9===e.keyCode?(t=l()+n.length,(i=window.getSelection().getRangeAt(0)).deleteContents(),i.insertNode(document.createTextNode(n)),a(t),e.preventDefault()):8===e.keyCode&&setTimeout(e=>{if(1===s.el.childNodes.length&&"br"===s.el.firstChild.localName){var t=document.createElement("div");t.innerHTML="&nbsp;",t.className=s.el.firstChild.className,s.el.firstChild.remove(),s.el.appendChild(t),a(0)}else{var i,n,r;for(i of Array.from(s.el.childNodes))"br"===i.localName&&(n=document.createElement("div"),r=l(),n.innerHTML="&nbsp;",i.replaceWith(n),a(r+1))}},10),"z"===e.key&&e.ctrlKey?s.undoManager.undo():"y"===e.key&&e.ctrlKey?s.undoManager.redo():s.publish("keydown",e)}),o.addEventListener("keyup",e=>{if(!e.ctrlKey&&48<=e.keyCode||32===e.keyCode){var t=l();s.process(),a(t)}else switch(e.keyCode){case 8:break;case 13:e.ctrlKey?s.runSelection():e.altKey&&s.runBlock()}s.publish("keyup",e)}),o.addEventListener("click",e=>s.publish("click",e))}};