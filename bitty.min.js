let bitty=window.bitty={instances:[],config:{flashTime:250,flashColor:"black",flashBackground:"white",value:"// itty bitty ide"},events:{},rules:{},create(e={}){let t=null;t=void 0===e.el?document.querySelector('[contenteditable="true"]'):e.el;var n=Object.create(bitty),e=(n.el=t,Object.defineProperty(n,"value",{set(e){e=this.process(e,!0),e=this.divide(e);this.el.innerHTML=e},get(){return this.el.innerText}}),Object.assign({},bitty.config,e)),i=e.value;return delete e.value,Object.assign(n,e,{events:{}}),void 0!==i&&(n.value=i),n.editor(n,t),n.publish("init",n),bitty.publish("new",n),t.focus(),bitty.instances.push(n),n},divide(e){return e.split("\n").map(e=>" "===e||""===e?" ":e).map(e=>`<div>${e}</div>`).join("")},focus(){this.el.focus()},process(e,t=!1){var n=this.el,i=Object.keys(this.rules),l=this.rules;if(t)for(var r of i)e=e.replace(l[r],`<span class=bitty-${r}>$1</span>`);else for(var o of n.children){e=o.innerText;for(var s of i)e=e.replace(l[s],`<span class=bitty-${s}>$1</span>`);o.innerHTML=e.split("\n").join("<br/>")}return e},subscribe(e,t){var n=this.events;void 0===n[e]&&(n[e]=[]),n[e].push(t)},unsubscribe(e,t){var n=this.events;void 0!==n[e]&&(n=n[e]).splice(n.indexOf(t),1)},publish(e,t){var n=this.events;void 0!==n[e]&&n[e].forEach(e=>e(t))},runBlock(){var e;let t=window.getSelection().anchorNode.parentElement,n=[];for(;"div"!==t.localName;)t=t.parentElement;let i=t.style.background,l=t.style.color;for(;null!==t.previousSibling&&"\n"!==t.previousSibling.innerText&&"div"===t.previousSibling.localName;)t=t.previousSibling;for(n.push(t);null!==t.nextSibling&&"\n"!==t.nextSibling.innerText&&"div"===t.nextSibling.localName;)t=t.nextSibling,n.push(t);n.forEach(e=>{e.style&&(e.style.background=bitty.config.flashBackground,e.style.color=bitty.config.flashColor)}),setTimeout(e=>{n.forEach(e=>{e.style&&(e.style.background=i,e.style.color=l)})},this.config.flashTime),e=n.map(e=>e.innerText).join("\n"),this.publish("run",e)},runSelection(){var i=window.getSelection();let l=i.toString();if(""===l){let e=i.anchorNode.parentElement;for(;"div"!==e.localName;)e=e.parentElement;l=e.innerText;let t=e.style.background,n=e.style.color;e.style.background=bitty.config.flashBackground,e.style.color=bitty.config.flashColor,setTimeout(()=>{e.style.background=t,e.style.color=n},this.config.flashTime)}else{let e=document.styleSheets[0],t=e.insertRule("::selection{ color:black !important; background:white !important}");setTimeout(()=>e.removeRule(t),250)}this.publish("run",l)},editor(e,r,i="  "){let o=e,s=()=>{var e=window.getSelection().getRangeAt(0),t=e.cloneRange();return t.selectNodeContents(r),t.setEnd(e.endContainer,e.endOffset),t.toString().length},a=(e,t=r)=>{for(var n of t.childNodes)if(n.nodeType==Node.TEXT_NODE){var i,l;if(n.length>=e)return i=document.createRange(),l=window.getSelection(),i.setStart(n,e),i.collapse(!0),l.removeAllRanges(),l.addRange(i),-1;e-=n.length}else if((e=a(e,n))<0)return e;return e};new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.length?o.publish("nodes added",e.addedNodes):o.publish("nodes removed",e.removedNodes)})}).observe(r,{childList:!0});r.addEventListener("paste",e=>{var t=(e.clipboardData||window.clipboardData).getData("text/plain");if(1!==t.split("\n").length&&window.getSelection().rangeCount){let i=s();var n=t.split("\n").length-1,t=(i+=t.length-n,""===e.target.innerText||" "===e.target.innerText||"\n"===e.target.innerText||"<br>"===e.target.innerText);e.target!==o.el&&t&&e.target.remove(),setTimeout(()=>{o.el.innerHTML=o.divide(o.value),o.process(),setTimeout(()=>{for(var e of Array.from(o.el.childNodes))if(3!==e.nodeType){var t=e.querySelectorAll("div");if(1<t.length)for(var n of t)o.el.insertBefore(n,e)}a(i)},0)},0),o.publish("paste",e)}}),r.addEventListener("keydown",e=>{var t,n;9===e.keyCode?(t=s()+i.length,(n=window.getSelection().getRangeAt(0)).deleteContents(),n.insertNode(document.createTextNode(i)),a(t),e.preventDefault()):8===e.keyCode&&setTimeout(e=>{if(1===o.el.childNodes.length&&"br"===o.el.firstChild.localName){var t=document.createElement("div");t.innerHTML="&nbsp;",t.className=o.el.firstChild.className,o.el.firstChild.remove(),o.el.appendChild(t),a(0)}else{var n,i,l;for(n of Array.from(o.el.childNodes))"br"===n.localName&&(i=document.createElement("div"),l=s(),i.innerHTML="&nbsp;",n.replaceWith(i),a(l+1))}},10),o.publish("keydown",e)}),r.addEventListener("keyup",e=>{if(!e.ctrlKey&&48<=e.keyCode||32===e.keyCode){var t=s();o.process(),a(t)}else switch(e.keyCode){case 8:break;case 13:e.ctrlKey?o.runSelection():e.altKey&&o.runBlock()}o.publish("keyup",e)}),r.addEventListener("click",e=>o.publish("click",e))}};