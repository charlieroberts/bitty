window.bitty={__active:null,config:{flashTime:250,flashColor:"black",flashBackground:"white",value:"// itty bitty ide"},events:{},set value(e){let t=bitty.process(e,!0);t=t.split("\n").map(e=>""===e?"<br/>":e).map(e=>`<div>${e}</div>`).join(""),bitty.el.innerHTML=t},get value(){return bitty.el.innerText},init(e={}){let t=null;t=void 0===e.element?document.querySelector('div[contenteditable="true"]'):e.element,bitty.el=t,Object.assign(bitty.config,e),bitty.value=bitty.config.value,bitty.editor(t),bitty.__active=t.firstChild,bitty.__active.classList.add("active"),t.focus()},rules:{},process(e,t=!1){let i;var n=Object.keys(bitty.rules),l=bitty.rules;if(t){i=e;for(var o of n)i=i.replace(l[o],`<span class=bitty-${o}>$1</span>`)}else for(var r of e.children){i=r.innerText;for(var a of n)i=i.replace(l[a],`<span class=bitty-${a}>$1</span>`);r.innerHTML=i.split("\n").join("<br/>")}return i},processold(e,t=!1){let i;if(t)i=e,bitty.rules.forEach(e=>{i=i.replace(e[0],e[1])});else for(var n of e.children)i=n.innerText,bitty.rules.forEach(e=>{i=i.replace(e[0],e[1])}),n.innerHTML=i.split("\n").join("<br/>");return i},subscribe(e,t){var i=bitty.events;void 0===i[e]&&(i[e]=[]),i[e].push(t)},unsubscribe(e,t){var i=bitty.events;void 0!==i[e]&&(i=i[e]).splice(i.indexOf(t),1)},publish(e,t){var i=bitty.events;void 0!==i[e]&&i[e].forEach(e=>e(t))},runBlock(){var e;let t=window.getSelection().anchorNode.parentElement,i=[];for(;"div"!==t.localName;)t=t.parentElement;let n=t.style.background,l=t.style.color;for(;null!==t.previousSibling&&"\n"!==t.previousSibling.innerText&&"div"===t.previousSibling.localName;)t=t.previousSibling;for(i.push(t);null!==t.nextSibling&&"\n"!==t.nextSibling.innerText&&"div"===t.nextSibling.localName;)t=t.nextSibling,i.push(t);i.forEach(e=>{e.style&&(e.style.background=bitty.config.flashBackground,e.style.color=bitty.config.flashColor)}),setTimeout(e=>{i.forEach(e=>{e.style&&(e.style.background=n,e.style.color=l)})},bitty.config.flashTime),e=i.map(e=>e.innerText).join("\n"),bitty.publish("run",e)},runSelection(){var n=window.getSelection();let l=n.toString();if(""===l){let e=n.anchorNode.parentElement;for(;"div"!==e.localName;)e=e.parentElement;l=e.innerText;let t=e.style.background,i=e.style.color;e.style.background=bitty.config.flashBackground,e.style.color=bitty.config.flashColor,setTimeout(()=>{e.style.background=t,e.style.color=i},bitty.config.flashTime)}else{let e=document.styleSheets[0],t=e.insertRule("::selection{ color:black !important; background:white !important}");setTimeout(()=>e.removeRule(t),250)}bitty.publish("run",l)},editor(o,n=bitty.process,l="  "){let r=()=>{var e=window.getSelection().getRangeAt(0),t=e.cloneRange();return t.selectNodeContents(o),t.setEnd(e.endContainer,e.endOffset),t.toString().length},a=(e,t=o)=>{for(var i of t.childNodes)if(i.nodeType==Node.TEXT_NODE){var n,l;if(i.length>=e)return n=document.createRange(),l=window.getSelection(),n.setStart(i,e),n.collapse(!0),l.removeAllRanges(),l.addRange(n),-1;e-=i.length}else if((e=a(e,i))<0)return e;return e};o.addEventListener("keydown",e=>{var t,i;9===e.keyCode?(t=r()+l.length,(i=window.getSelection().getRangeAt(0)).deleteContents(),i.insertNode(document.createTextNode(l)),n(o),a(t),e.preventDefault()):38!==e.keyCode&&40!==e.keyCode||(i=bitty.__active,bitty.__active.classList.remove("active"),bitty.__active=38===e.keyCode?bitty.__active.previousSibling:bitty.__active.nextSibling,null===bitty.__active&&(bitty.__active=i),bitty.__active.classList.add("active"))}),o.addEventListener("keyup",e=>{var t;!e.ctrlKey&&48<=e.keyCode||32===e.keyCode?(t=r(),n(o),a(t)):13===e.keyCode&&(e.ctrlKey?bitty.runSelection():e.altKey&&bitty.runBlock())}),o.addEventListener("click",e=>{let t=e.target;for(;"div"!==t.localName;)t=t.parentElement;t.classList.add("active"),null!==bitty.__active&&bitty.__active.classList.remove("active"),bitty.__active=t})}};